---
title: "testing"
output: html_document
date: "2025-08-18"
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "~/projects/021_ltee_models/NeutralKaryotypes/")
```


```{r}
ids <- readLines("karyotyped_samples.txt")

mrcas <- c("SUM-159_NLS_4N_MRCA_harvest",
           "MDA-MB-231_MRCA_harvest",
           "HGC-27_MRCA_harvest",
           "SUM-159_NLS_2N_MRCA_harvest",
           "SNU-668_MRCA_harvest")
```

```{r}
require(DBI)
source("R/db_utils.R")
dbvars <- load_db_vars("db_creds.txt")
db <- dbConnect(
    MariaDB(),
    host = dbvars["HOST"],
    user = dbvars["USER"],
    password = dbvars["PASSWORD"],
    dbname = dbvars["DBNAME"]
)

x <- dbGetQuery(db, "SELECT * FROM Passaging")
m <- dbGetQuery(db,"SELECT * FROM Media")

```
```{r}

find_all_ancestors <- function(id,g){
  ids <- c()
    while(!is.na(id)){
      ids <- c(id,ids)
      id <- g$passaged_from_id1[g$id==id]
    }
  return(ids)
}

mrca_an <- lapply(mrcas,find_all_ancestors,g=x)
id_an <- lapply(ids,find_all_ancestors,g=x)

## which mrca belongs to each id?
id_map <- lapply(id_an,function(lin1){
  ix <- which.max(sapply(mrca_an,function(lin2){
    sum(lin1[1:length(lin2)]==lin2)
  }))
  
  list(id_start=mrcas[ix],id_end=tail(lin1,1))
  
})


```

```{r}
karyotypes <- get_karyotyping(c(mrcas,ids))
```

```{r}
source("R/estimate_pmis.R")


fit_objects <- lapply(id_map,function(id){
  
  id$K0 <- do.call(rbind,karyotypes$karyotype[karyotypes$id==id$id_start])
  if(!id$id_end%in%karyotypes$id){
    print(id$id_end)
    return(NULL)
  }
  id$KT <- do.call(rbind,karyotypes$karyotype[karyotypes$id==id$id_end])
  
  id$H0 <- hist_mat_from_matrix(round(id$K0))
  id$HT <- hist_mat_from_matrix(round(id$KT))
  
  id$delta_pass <- x$passage[x$id==id$id_end]-x$passage[x$id==id$id_start]
  id
})
fit_objects <- fit_objects[!sapply(fit_objects,is.null)]
saveRDS(fit_objects,"fit_objects.Rds")
```

```{r}
ff <- list.files("data/fits/",full.names = T)

df <- do.call(rbind,lapply(ff,function(fi){
  res <- readRDS(fi)
  if(!"test_null_res"%in%names(res)) return(NULL)
  print(res$id_start)
  data.frame(start=res$id_start,end=res$id_end,p=res$test_null_res$empp,delta_pass=res$delta_pass)
}))
df <- df[order(df$p),]

data.table::fwrite(df,"data/neutral_probability.csv",sep=",")

```

```{r}
x <- readRDS("data/fits/SNU-668_C_A4_seed.Rds")
y <- readRDS("data/pops/SNU-668_C_A4_seed.Rds")
```


```{r}
KT <- round(x$KT)
image(hist_mat_from_named_counts(y[[1]]))
image(x$H0)
image(x$HT)
pop <- y[1:50]

library(transport)
  
  sampleToInt <- function(pp, Nsam=20) {
    samstr <- sample(names(pp), size = Nsam, prob = pp)
    samstr <- table(samstr)
    # Ensure consistent matrix dimensions for 22 chromosomes/bins
    coords <- matrix(as.numeric(unlist(strsplit(names(samstr), split="[.]"))), ncol=22, byrow = TRUE)
    list(coords = coords, counts = samstr)
  }
  
  Nsam <- nrow(KT)
  
  # Process Target (KT)
  samstr <- table(apply(KT, 1, paste, collapse="."))
  smm <- list(
    coords = matrix(as.numeric(unlist(strsplit(names(samstr), split="[.]"))), ncol=22, byrow = TRUE),
    counts = samstr
  )
  wtst <- wpp(smm$coords, mass = smm$counts)
  
  # 1. Internal distances (Null distribution)
  dnull <- sapply(1:length(pop), function(i) {
    sapply(1:length(pop), function(j) {
      if (i >= j) return(NaN)
      
      popi <- sampleToInt(pop[[i]], Nsam)
      popj <- sampleToInt(pop[[j]], Nsam)
      
      wi <- wpp(popi$coords, mass = popi$counts)
      wj <- wpp(popj$coords, mass = popj$counts)
      
      wasserstein(wi, wj)
    })
  })
  dnull <- dnull[is.finite(dnull)]
  
  # 2. Test distances (Populations vs Target)
  dtst <- sapply(1:length(pop), function(j) {
    popj <- sampleToInt(pop[[j]], Nsam)
    
    wj <- wpp(popj$coords, mass = popj$counts)
    wasserstein(wj, wtst)
  })
  
  tst_stat <- median(dtst)
  empp <- mean(dnull > tst_stat)

```

