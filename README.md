# Neutral Karyotype Evolution Simulator

This repository contains the code and analysis pipeline for simulating karyotype evolution under a neutral model of chromosome mis-segregation. The primary goal is to estimate the per-chromosome mis-segregation probability (`p_misseg`) by comparing simulated karyotype distributions to observed experimental data.

## Overview

The core of this project is a C++ simulation engine (invoked via R) that models the division of cells and the potential for aneuploidy. The simulation tracks the karyotypes of a cell population over time, subject to a given rate of chromosome mis-segregation.

The main workflow, detailed in `workflow.Rmd`, involves:
1.  **Data Loading and Preprocessing**: Karyotype data, stored in `karyotypes.Rds`, is loaded. This includes observed karyotype vectors and metadata about cell lineages and passaging history.
2.  **Lineage Reconstruction**: The passaging history is used to construct lineage trees for different cell lines, identifying the Most Recent Common Ancestor (MRCA) for each independent lineage. The resulting trees are saved in the `trees/` directory.
3.  **Parameter Estimation**: For a given lineage, the simulation is run across a range of `p_misseg` values. The negative log-likelihood of observing the endpoint karyotype distribution is calculated for each simulation run to find the most likely `p_misseg`.
4.  **Hypothesis Testing**: A null distribution of karyotype distances (using the Wasserstein distance) is generated from simulations running at the estimated `p_misseg`. This is compared against the distance between the simulated endpoint and the actual observed endpoint to test the model's fit.

## Core Components

* `workflow.Rmd`: The main R Markdown file that orchestrates the entire analysis pipeline, from data loading to plotting results.
* `ksim2.cpp`: The primary C++ simulation engine, which is compiled and called from R using `Rcpp`. It implements the core logic for cell division, chromosome mis-segregation, and population culling.
* `R/estimate_pmis.R`: An R script containing helper functions for running the simulations, calculating negative log-likelihood (`get_nll`), and processing karyotype data into the required histogram format.
* `karyotypes.Rds` / `karyotypes_mod.Rds`: The input data files containing the experimental karyotype vectors and associated metadata.
* `trees/`: A directory containing PNG images of the reconstructed lineage trees for different cell lines, generated by the workflow.

## How to Run

1.  **Prerequisites**: Ensure you have R installed with the following packages: `Rcpp`, `igraph`, `ggplot2`, `ggrepel`, `grid`, `parallel`, `transport`, and `reshape2`.
2.  **Execution**: Open the `workflow.Rmd` file in an R environment (like RStudio).
3.  **Run Chunks**: Execute the R code chunks sequentially to perform the analysis. The workflow is set up to load data, build lineage trees, estimate mis-segregation rates for specific lineages (e.g., SNU-668), and generate plots.

## Simulation Details

The simulation operates on a population of cells, each defined by a vector of chromosome copy numbers. Key parameters include:
* `rate`: The per-cell division rate.
* `p_misseg`: The probability of a single chromosome mis-segregating during division.
* `max_pop`: The maximum population size, triggering a cull when exceeded.
* `cull_keep`: The fraction of the population that survives a culling event.

The simulation uses a balanced mis-segregation model where a lost chromosome in one daughter cell results in a gain in the other. A division can result in two valid daughters, one valid daughter, or two invalid daughters (leading to cell death).
